<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- HTML5æ–‡æ¡£ç±»å‹å£°æ˜ -->
    <meta charset="UTF-8">
    <!-- è®¾ç½®å­—ç¬¦ç¼–ç ä¸ºUTF-8ï¼Œæ”¯æŒä¸­æ–‡æ˜¾ç¤º -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- å“åº”å¼è®¾è®¡é…ç½®ï¼šé€‚é…ç§»åŠ¨è®¾å¤‡ï¼Œåˆå§‹ç¼©æ”¾æ¯”ä¾‹1:1 -->
    <title>AIå¯¹è¯åŠ©æ‰‹ - æµå¼ä¼ è¾“</title>
    <!-- é¡µé¢æ ‡é¢˜ï¼Œæ˜¾ç¤ºåœ¨æµè§ˆå™¨æ ‡ç­¾é¡µ -->

    <style>
        /* ===== å…¨å±€æ ·å¼é…ç½® ===== */
        body {
            font-family: Arial, sans-serif;    /* è®¾ç½®æ— è¡¬çº¿å­—ä½“ï¼Œæé«˜å¯è¯»æ€§ */
            max-width: 800px;                  /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œé¿å…åœ¨å¤§å±å¹•ä¸Šè¿‡äºå®½æ³› */
            margin: 50px auto;                 /* ä¸Šä¸‹è¾¹è·50pxï¼Œå·¦å³è‡ªåŠ¨å±…ä¸­ */
            padding: 20px;                     /* å†…è¾¹è·20pxï¼Œç»™å†…å®¹ç•™å‡ºå‘¼å¸ç©ºé—´ */
            background-color: #f5f5f5;         /* æµ…ç°è‰²èƒŒæ™¯ï¼ŒæŸ”å’Œä¸åˆºçœ¼ */
        }

        /* ===== ä¸»å®¹å™¨æ ·å¼ ===== */
        .container {
            background: white;                  /* ç™½è‰²èƒŒæ™¯ï¼Œä¸é¡µé¢èƒŒæ™¯å½¢æˆå¯¹æ¯” */
            padding: 30px;                     /* å†…è¾¹è·30pxï¼Œå†…å®¹ä¸è´´è¾¹ */
            border-radius: 10px;               /* åœ†è§’è¾¹æ¡†ï¼Œç°ä»£åŒ–è®¾è®¡ */
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);  /* é˜´å½±æ•ˆæœï¼Œå¢åŠ ç«‹ä½“æ„Ÿ */
        }

        /* ===== æ ‡é¢˜æ ·å¼ ===== */
        h1 {
            color: #333;                       /* æ·±ç°è‰²æ–‡å­—ï¼Œä¸ä¼šè¿‡äºçªå…€ */
            text-align: center;                /* æ–‡å­—å±…ä¸­å¯¹é½ */
            margin-bottom: 30px;               /* ä¸‹è¾¹è·30pxï¼Œä¸ä¸‹æ–¹å†…å®¹åˆ†ç¦» */
        }

        /* ===== èŠå¤©æ¡†æ ·å¼ ===== */
        .chat-box {
            height: 500px;                     /* å›ºå®šé«˜åº¦500pxï¼Œç¡®ä¿ç•Œé¢ç¨³å®š */
            overflow-y: auto;                  /* å‚ç›´æ»šåŠ¨ï¼Œå†…å®¹è¶…å‡ºæ—¶æ˜¾ç¤ºæ»šåŠ¨æ¡ */
            border: 1px solid #ddd;            /* æµ…ç°è‰²è¾¹æ¡†ï¼Œåˆ’åˆ†åŒºåŸŸ */
            padding: 15px;                     /* å†…è¾¹è·15pxï¼Œå†…å®¹ä¸è´´è¾¹ */
            margin-bottom: 20px;               /* ä¸‹è¾¹è·20pxï¼Œä¸è¾“å…¥åŒºåŸŸåˆ†ç¦» */
            background-color: #fafafa;         /* ææµ…ç°èƒŒæ™¯ï¼ŒåŒºåˆ«äºä¸»å®¹å™¨ */
            border-radius: 5px;                /* å°åœ†è§’ï¼Œä¿æŒä¸€è‡´æ€§ */
        }

        /* ===== æ¶ˆæ¯é€šç”¨æ ·å¼ ===== */
        .message {
            margin-bottom: 15px;               /* æ¶ˆæ¯é—´è·15pxï¼Œæ¸…æ™°åˆ†ç¦» */
            padding: 10px;                     /* å†…è¾¹è·10pxï¼Œæ–‡å­—ä¸è´´è¾¹ */
            border-radius: 8px;                /* åœ†è§’è®¾è®¡ï¼Œç°ä»£åŒ–å¤–è§‚ */
        }

        /* ===== ç”¨æˆ·æ¶ˆæ¯æ ·å¼ ===== */
        .user-message {
            background-color: #007bff;         /* è“è‰²èƒŒæ™¯ï¼Œè¡¨ç¤ºç”¨æˆ·æ¶ˆæ¯ */
            color: white;                      /* ç™½è‰²æ–‡å­—ï¼Œä¸èƒŒæ™¯å½¢æˆå¯¹æ¯” */
            text-align: right;                 /* å³å¯¹é½ï¼Œç¬¦åˆèŠå¤©åº”ç”¨ä¹ æƒ¯ */
            margin-left: 20%;                  /* å·¦è¾¹è·20%ï¼Œåˆ›é€ æ°”æ³¡æ•ˆæœ */
        }

        /* ===== AIæ¶ˆæ¯æ ·å¼ ===== */
        .ai-message {
            background-color: #e9ecef;         /* æµ…ç°è‰²èƒŒæ™¯ï¼Œè¡¨ç¤ºAIæ¶ˆæ¯ */
            color: #333;                       /* æ·±ç°è‰²æ–‡å­—ï¼Œæ˜“äºé˜…è¯» */
            margin-right: 20%;                 /* å³è¾¹è·20%ï¼Œä¸ç”¨æˆ·æ¶ˆæ¯åŒºåˆ† */
        }

        /* ===== æµå¼ä¼ è¾“æ¶ˆæ¯æ ·å¼ ===== */
        .streaming-message {
            background-color: #f8f9fa;         /* ææµ…ç°èƒŒæ™¯ï¼Œè¡¨ç¤ºæ­£åœ¨æ¥æ”¶ */
            border: 2px solid #28a745;         /* ç»¿è‰²è¾¹æ¡†ï¼Œè¡¨ç¤ºæ´»è·ƒçŠ¶æ€ */
            border-radius: 8px;                /* åœ†è§’è®¾è®¡ */
            margin-right: 20%;                 /* å³è¾¹è·20%ï¼Œä¸AIæ¶ˆæ¯ä¸€è‡´ */
        }

        /* ===== è¾“å…¥ç»„æ ·å¼ ===== */
        .input-group {
            display: flex;                     /* å¼¹æ€§å¸ƒå±€ï¼Œæ°´å¹³æ’åˆ— */
            gap: 10px;                         /* å…ƒç´ é—´è·10px */
        }

        /* ===== è¾“å…¥æ¡†æ ·å¼ ===== */
        #messageInput {
            flex: 1;                          /* å æ®å‰©ä½™ç©ºé—´ */
            padding: 12px;                    /* å†…è¾¹è·12pxï¼Œå¢åŠ ç‚¹å‡»åŒºåŸŸ */
            border: 1px solid #ddd;           /* æµ…ç°è‰²è¾¹æ¡† */
            border-radius: 5px;               /* å°åœ†è§’ */
            font-size: 16px;                  /* 16pxå­—ä½“ï¼Œé¿å…ç§»åŠ¨ç«¯ç¼©æ”¾ */
        }

        /* ===== æŒ‰é’®æ ·å¼ ===== */
        button {
            padding: 12px 24px;               /* å†…è¾¹è·ï¼šä¸Šä¸‹12pxï¼Œå·¦å³24px */
            background-color: #28a745;        /* ç»¿è‰²èƒŒæ™¯ï¼Œè¡¨ç¤ºç§¯ææ“ä½œ */
            color: white;                      /* ç™½è‰²æ–‡å­— */
            border: none;                      /* ç§»é™¤é»˜è®¤è¾¹æ¡† */
            border-radius: 5px;                /* åœ†è§’è®¾è®¡ */
            cursor: pointer;                   /* é¼ æ ‡æŒ‡é’ˆæ ·å¼ */
            font-size: 16px;                  /* ä¸è¾“å…¥æ¡†å­—ä½“å¤§å°ä¸€è‡´ */
        }

        /* ===== æŒ‰é’®æ‚¬åœæ•ˆæœ ===== */
        button:hover {
            opacity: 0.8;                     /* æ‚¬åœæ—¶é€æ˜åº¦é™ä½ï¼Œæä¾›è§†è§‰åé¦ˆ */
        }

        /* ===== æŒ‰é’®ç¦ç”¨æ ·å¼ ===== */
        button:disabled {
            background-color: #6c757d;        /* ç°è‰²èƒŒæ™¯ï¼Œè¡¨ç¤ºä¸å¯ç”¨ */
            cursor: not-allowed;               /* ç¦æ­¢å›¾æ ‡ï¼Œæ˜ç¡®çŠ¶æ€ */
        }

        /* ===== æ‰“å­—æŒ‡ç¤ºå™¨æ ·å¼ ===== */
        .typing-indicator {
            display: inline-block;             /* è¡Œå†…å—å…ƒç´  */
            position: relative;                /* ç›¸å¯¹å®šä½ï¼Œä¸ºä¼ªå…ƒç´ å®šä½ */
        }

        /* ===== æ‰“å­—æŒ‡ç¤ºå™¨åŠ¨ç”» ===== */
        .typing-indicator::after {
            content: '|';                      /* æ˜¾ç¤ºç«–çº¿ç¬¦å· */
            animation: blink 1s infinite;      /* é—ªçƒåŠ¨ç”»ï¼Œ1ç§’å‘¨æœŸï¼Œæ— é™å¾ªç¯ */
        }

        /* ===== é—ªçƒåŠ¨ç”»å®šä¹‰ ===== */
        @keyframes blink {
            0%, 50% { opacity: 1; }           /* å‰50%æ—¶é—´å®Œå…¨æ˜¾ç¤º */
            51%, 100% { opacity: 0; }         /* å50%æ—¶é—´å®Œå…¨éšè— */
        }

        /* ===== çŠ¶æ€æŒ‡ç¤ºå™¨æ ·å¼ ===== */
        .status-indicator {
            display: inline-block;             /* è¡Œå†…å—å…ƒç´  */
            width: 8px;                        /* å®½åº¦8px */
            height: 8px;                       /* é«˜åº¦8pxï¼Œå½¢æˆåœ†å½¢ */
            background-color: #28a745;         /* ç»¿è‰²èƒŒæ™¯ï¼Œè¡¨ç¤ºåœ¨çº¿çŠ¶æ€ */
            border-radius: 50%;                /* 50%åœ†è§’ï¼Œå½¢æˆåœ†å½¢ */
            margin-right: 5px;                 /* å³è¾¹è·5pxï¼Œä¸æ–‡å­—åˆ†ç¦» */
            animation: pulse 2s infinite;      /* è„‰å†²åŠ¨ç”»ï¼Œ2ç§’å‘¨æœŸ */
        }

        /* ===== è„‰å†²åŠ¨ç”»å®šä¹‰ ===== */
        @keyframes pulse {
            0% { opacity: 1; }                /* å¼€å§‹æ—¶å®Œå…¨æ˜¾ç¤º */
            50% { opacity: 0.5; }             /* ä¸­é—´æ—¶åŠé€æ˜ */
            100% { opacity: 1; }              /* ç»“æŸæ—¶å®Œå…¨æ˜¾ç¤º */
        }

        /* ===== æµå¼ä¿¡æ¯æ ·å¼ ===== */
        .stream-info {
            font-size: 12px;                  /* å°å­—ä½“ï¼Œä¸å¹²æ‰°ä¸»è¦å†…å®¹ */
            color: #666;                       /* ä¸­ç°è‰²ï¼Œé™ä½è§†è§‰æƒé‡ */
            margin-top: 5px;                   /* ä¸Šè¾¹è·5pxï¼Œä¸ä¸»è¦å†…å®¹åˆ†ç¦» */
            font-style: italic;                /* æ–œä½“ï¼Œè¡¨ç¤ºè¾…åŠ©ä¿¡æ¯ */
        }
    </style>
</head>
<body>
    <!-- ===== ä¸»å®¹å™¨ ===== -->
    <div class="container">
        <!-- ===== é¡µé¢æ ‡é¢˜ ===== -->
        <h1>
            <span class="status-indicator"></span>
            <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ï¼šç»¿è‰²åœ†ç‚¹è¡¨ç¤ºç³»ç»Ÿåœ¨çº¿ -->
            ğŸ¤– AIå¯¹è¯åŠ©æ‰‹ - æµå¼ä¼ è¾“
        </h1>

        <!-- ===== èŠå¤©æ˜¾ç¤ºåŒºåŸŸ ===== -->
        <div id="chatBox" class="chat-box">
            <!-- åˆå§‹æ¬¢è¿æ¶ˆæ¯ -->
            <div class="message ai-message">
                <strong>AI:</strong> ä½ å¥½ï¼æˆ‘æ˜¯ä¸€ä¸ªAIå¯¹è¯åŠ©æ‰‹ï¼Œç°åœ¨é‡‡ç”¨æµå¼ä¼ è¾“æ¨¡å¼ï¼Œå¯ä»¥å®æ—¶æ˜¾ç¤ºå›å¤å†…å®¹ã€‚æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ
            </div>
        </div>

        <!-- ===== è¾“å…¥åŒºåŸŸ ===== -->
        <div class="input-group">
            <!-- æ¶ˆæ¯è¾“å…¥æ¡† -->
            <input type="text" id="messageInput" placeholder="è¾“å…¥ä½ çš„æ¶ˆæ¯..." onkeypress="handleKeyPress(event)">
            <!-- å‘é€æŒ‰é’® -->
            <button id="sendBtn" onclick="sendMessage()">ğŸŒŠ å‘é€æ¶ˆæ¯</button>
        </div>
    </div>

    <script>
        /* ===== å…¨å±€çŠ¶æ€å˜é‡ ===== */
        let isProcessing = false;              // æ˜¯å¦æ­£åœ¨å¤„ç†è¯·æ±‚çš„æ ‡å¿—
        let currentStreamingMessage = null;    // å½“å‰æ­£åœ¨æµå¼æ¥æ”¶çš„æ¶ˆæ¯å…ƒç´ å¼•ç”¨

        /**
         * é”®ç›˜äº‹ä»¶å¤„ç†å‡½æ•°
         * åŠŸèƒ½ï¼šç›‘å¬å›è½¦é”®ï¼Œè§¦å‘æ¶ˆæ¯å‘é€
         *
         * @param {KeyboardEvent} event - é”®ç›˜äº‹ä»¶å¯¹è±¡
         */
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();  // å›è½¦é”®å‘é€æ¶ˆæ¯ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
            }
        }

        /**
         * å‘é€æµå¼æ¶ˆæ¯çš„æ ¸å¿ƒå‡½æ•°
         * åŠŸèƒ½ï¼š
         * 1. éªŒè¯è¾“å…¥å’ŒçŠ¶æ€
         * 2. æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
         * 3. å‘èµ·æµå¼HTTPè¯·æ±‚
         * 4. å¤„ç†å“åº”æ•°æ®æµ
         * 5. æ›´æ–°UIçŠ¶æ€
         */
        function sendMessage() {
            // ===== ç¬¬1æ­¥ï¼šçŠ¶æ€æ£€æŸ¥å’Œè¾“å…¥éªŒè¯ =====
            if (isProcessing) return;  // é˜²æ­¢é‡å¤æäº¤ï¼Œé¿å…å¹¶å‘é—®é¢˜

            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();  // è·å–è¾“å…¥å†…å®¹å¹¶å»é™¤é¦–å°¾ç©ºç™½
            if (!message) return;  // ç©ºæ¶ˆæ¯ç›´æ¥è¿”å›ï¼Œä¸å‘é€è¯·æ±‚

            // ===== ç¬¬2æ­¥ï¼šè®¾ç½®å¤„ç†çŠ¶æ€ =====
            isProcessing = true;  // æ ‡è®°ä¸ºå¤„ç†ä¸­ï¼Œé˜»æ­¢æ–°çš„è¯·æ±‚
            console.log('ğŸŒŠ å‘é€æµå¼å¯¹è¯:', message);  // è°ƒè¯•æ—¥å¿—

            // ===== ç¬¬3æ­¥ï¼šUIæ›´æ–°æ“ä½œ =====
            addMessage('user', message);  // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            messageInput.value = '';       // æ¸…ç©ºè¾“å…¥æ¡†
            setButtonDisabled(true);       // ç¦ç”¨å‘é€æŒ‰é’®
            currentStreamingMessage = addStreamingMessage();  // åˆ›å»ºæµå¼æ¶ˆæ¯å®¹å™¨

            // ===== ç¬¬4æ­¥ï¼šå‘èµ·æµå¼HTTPè¯·æ±‚ =====
            fetch('/stream_chat', {
                method: 'POST',  // ä½¿ç”¨POSTæ–¹æ³•
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',  // è¡¨å•æ ¼å¼
                },
                body: `message=${encodeURIComponent(message)}`  // URLç¼–ç é˜²æ­¢ç‰¹æ®Šå­—ç¬¦é—®é¢˜
            })
            .then(response => {
                console.log('ğŸŒŠ å¼€å§‹æ¥æ”¶æµå¼æ•°æ®');

                // ===== ç¬¬5æ­¥ï¼šè·å–æµå¼è¯»å–å™¨ =====
                const reader = response.body.getReader();  // è·å–ReadableStreamè¯»å–å™¨
                const decoder = new TextDecoder();         // åˆ›å»ºæ–‡æœ¬è§£ç å™¨

                /**
                 * é€’å½’è¯»å–æµæ•°æ®çš„å†…éƒ¨å‡½æ•°
                 * åŠŸèƒ½ï¼šæŒç»­è¯»å–æ•°æ®å—ç›´åˆ°æµç»“æŸ
                 *
                 * æµè¯»å–åŸç†ï¼š
                 * 1. reader.read()è¿”å›Promise<{done: boolean, value: Uint8Array}>
                 * 2. done=trueè¡¨ç¤ºæµç»“æŸï¼ŒvalueåŒ…å«æ•°æ®å—
                 * 3. éœ€è¦ç”¨TextDecoderå°†å­—èŠ‚æ•°ç»„è½¬æ¢ä¸ºå­—ç¬¦ä¸²
                 * 4. é€’å½’è°ƒç”¨å®ç°æŒç»­è¯»å–
                 */
                function readStream() {
                    return reader.read().then(({ done, value }) => {
                        if (done) {
                            // æµç»“æŸå¤„ç†
                            console.log('ğŸŒŠ æµå¼ä¼ è¾“å®Œæˆ');
                            finishStreaming();  // æ¸…ç†çŠ¶æ€å’ŒUI
                            return;
                        }

                        // ===== ç¬¬6æ­¥ï¼šè§£ç å’Œè§£ææ•°æ® =====
                        const chunk = decoder.decode(value, { stream: true });
                        // stream: true è¡¨ç¤ºè¿™æ˜¯æµå¼è§£ç ï¼Œå¯èƒ½æœ‰ä¸å®Œæ•´çš„å­—ç¬¦
                        console.log('ğŸ” æ”¶åˆ°æ•°æ®å—:', chunk);

                        // ===== ç¬¬7æ­¥ï¼šè§£æSSEæ•°æ®æ ¼å¼ =====
                        /**
                         * SSEæ•°æ®æ ¼å¼è§£æï¼š
                         * - æ¯è¡Œä»¥"data: "å¼€å¤´
                         * - å¯èƒ½åŒ…å«å¤šè¡Œæ•°æ®
                         * - æ¶ˆæ¯ä¹‹é—´ç”¨ç©ºè¡Œåˆ†éš”
                         * - éœ€è¦é€è¡Œè§£æJSONæ•°æ®
                         */
                        const lines = chunk.split('\n');  // æŒ‰è¡Œåˆ†å‰²
                        for (const line of lines) {
                            if (line.trim() && line.startsWith('data: ')) {
                                try {
                                    const jsonStr = line.substring(6);  // ç§»é™¤"data: "å‰ç¼€
                                    const data = JSON.parse(jsonStr);   // è§£æJSONæ•°æ®
                                    handleStreamData(data);              // å¤„ç†è§£æåçš„æ•°æ®
                                } catch (e) {
                                    console.error('è§£æJSONé”™è¯¯:', e, line);
                                    // è®°å½•ä½†ä¸ä¸­æ–­å¤„ç†ï¼Œæé«˜å®¹é”™æ€§
                                }
                            }
                        }

                        return readStream();  // é€’å½’è°ƒç”¨ï¼Œç»§ç»­è¯»å–ä¸‹ä¸€ä¸ªæ•°æ®å—
                    });
                }

                return readStream();  // å¼€å§‹è¯»å–æµæ•°æ®
            })
            .catch(error => {
                // ===== é”™è¯¯å¤„ç† =====
                console.error('âŒ æµå¼å¯¹è¯é”™è¯¯:', error);
                if (currentStreamingMessage) {
                    updateStreamingMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
                }
                finishStreaming();  // ç¡®ä¿çŠ¶æ€é‡ç½®
            });
        }

        /**
         * å¤„ç†æµå¼æ•°æ®çš„æ ¸å¿ƒå‡½æ•°
         * åŠŸèƒ½ï¼šæ ¹æ®æ•°æ®ç±»å‹æ‰§è¡Œä¸åŒçš„å¤„ç†é€»è¾‘
         *
         * @param {Object} data - è§£æåçš„JSONæ•°æ®å¯¹è±¡
         * æ•°æ®æ ¼å¼ï¼š{type: string, content: string, ...}
         */
        function handleStreamData(data) {
            console.log('ğŸ” å¤„ç†æµå¼æ•°æ®:', data);

            // ===== æ ¹æ®æ¶ˆæ¯ç±»å‹åˆ†å‘å¤„ç† =====
            switch (data.type) {
                case 'start':
                    // æµå¼ä¼ è¾“å¼€å§‹
                    console.log('ğŸŒŠ æµå¼å¼€å§‹');
                    updateStreamingMessage('<span class="typing-indicator"></span>');
                    // æ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨ï¼Œç»™ç”¨æˆ·è§†è§‰åé¦ˆ
                    break;

                case 'chunk':
                    // æ¥æ”¶å†…å®¹å—
                    if (data.content) {
                        appendToStreamingMessage(data.content);
                        // å°†æ–°å†…å®¹è¿½åŠ åˆ°ç°æœ‰å†…å®¹åé¢
                    }
                    break;

                case 'end':
                    // æµå¼ä¼ è¾“ç»“æŸ
                    console.log('ğŸŒŠ æµå¼ç»“æŸ');
                    finishStreaming();
                    // å®Œæˆæµå¼ä¼ è¾“ï¼Œé‡ç½®çŠ¶æ€
                    break;

                case 'error':
                    // æœåŠ¡å™¨é”™è¯¯
                    console.error('âŒ æµå¼é”™è¯¯:', data.content);
                    updateStreamingMessage(data.content);
                    finishStreaming();
                    break;

                default:
                    console.warn('æœªçŸ¥çš„æ•°æ®ç±»å‹:', data.type);
            }
        }

        /**
         * æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©æ¡†
         * åŠŸèƒ½ï¼šåˆ›å»ºæ¶ˆæ¯DOMå…ƒç´ å¹¶æ·»åŠ åˆ°èŠå¤©åŒºåŸŸ
         *
         * @param {string} sender - å‘é€è€…ç±»å‹ï¼š'user' æˆ– 'ai'
         * @param {string} message - æ¶ˆæ¯å†…å®¹
         * @returns {HTMLElement} åˆ›å»ºçš„æ¶ˆæ¯å…ƒç´ 
         */
        function addMessage(sender, message) {
            const chatBox = document.getElementById('chatBox');
            const messageDiv = document.createElement('div');

            // ===== è®¾ç½®æ¶ˆæ¯æ ·å¼ =====
            messageDiv.className = `message ${sender === 'user' ? 'user-message' : 'ai-message'}`;

            // ===== è®¾ç½®æ¶ˆæ¯å†…å®¹ =====
            const prefix = sender === 'user' ? 'ä½ :' : 'AI:';
            messageDiv.innerHTML = `<strong>${prefix}</strong> ${message}`;

            // ===== æ·»åŠ åˆ°èŠå¤©æ¡†å¹¶æ»šåŠ¨ =====
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;  // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨

            return messageDiv;
        }

        /**
         * æ·»åŠ æµå¼æ¶ˆæ¯å®¹å™¨
         * åŠŸèƒ½ï¼šåˆ›å»ºä¸“é—¨ç”¨äºæµå¼æ¥æ”¶çš„æ¶ˆæ¯å®¹å™¨
         *
         * @returns {HTMLElement} æµå¼æ¶ˆæ¯å®¹å™¨å…ƒç´ 
         */
        function addStreamingMessage() {
            const chatBox = document.getElementById('chatBox');
            const messageDiv = document.createElement('div');
            const uniqueId = 'streaming-' + Date.now();  // ç”Ÿæˆå”¯ä¸€ID

            // ===== è®¾ç½®æµå¼æ¶ˆæ¯æ ·å¼å’Œç»“æ„ =====
            messageDiv.className = 'message streaming-message';
            messageDiv.id = 'currentStreamingMessage';
            messageDiv.innerHTML = `
                <strong>AI:</strong>
                <span id="${uniqueId}">å‡†å¤‡æ¥æ”¶...</span>
                <div class="stream-info">æµå¼ä¼ è¾“ä¸­...</div>
            `;

            // ===== æ·»åŠ åˆ°èŠå¤©æ¡† =====
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;

            // ===== å­˜å‚¨å†…å®¹IDä»¥ä¾¿åç»­æ“ä½œ =====
            messageDiv.setAttribute('data-content-id', uniqueId);

            return messageDiv;
        }

        /**
         * æ›´æ–°æµå¼æ¶ˆæ¯å†…å®¹
         * åŠŸèƒ½ï¼šæ›¿æ¢æµå¼æ¶ˆæ¯çš„å†…å®¹
         *
         * @param {string} content - æ–°çš„å†…å®¹
         */
        function updateStreamingMessage(content) {
            if (currentStreamingMessage) {
                const contentId = currentStreamingMessage.getAttribute('data-content-id');
                const streamingContent = document.getElementById(contentId);
                if (streamingContent) {
                    streamingContent.innerHTML = content;
                    scrollToBottom();
                }
            }
        }

        /**
         * è¿½åŠ å†…å®¹åˆ°æµå¼æ¶ˆæ¯
         * åŠŸèƒ½ï¼šåœ¨ç°æœ‰å†…å®¹åé¢è¿½åŠ æ–°å†…å®¹ï¼ˆæ ¸å¿ƒæµå¼æ˜¾ç¤ºé€»è¾‘ï¼‰
         *
         * @param {string} content - è¦è¿½åŠ çš„å†…å®¹
         */
        function appendToStreamingMessage(content) {
            if (currentStreamingMessage) {
                const contentId = currentStreamingMessage.getAttribute('data-content-id');
                const streamingContent = document.getElementById(contentId);
                if (streamingContent) {
                    // ===== ç§»é™¤æ‰“å­—æŒ‡ç¤ºå™¨ =====
                    streamingContent.innerHTML = streamingContent.innerHTML.replace(
                        '<span class="typing-indicator"></span>',
                        ''
                    );

                    // ===== è¿½åŠ æ–°å†…å®¹ =====
                    streamingContent.innerHTML += content;
                    scrollToBottom();
                }
            }
        }

        /**
         * å®Œæˆæµå¼ä¼ è¾“
         * åŠŸèƒ½ï¼šæ¸…ç†æµå¼ä¼ è¾“çŠ¶æ€ï¼Œé‡ç½®UI
         */
        function finishStreaming() {
            if (currentStreamingMessage) {
                // ===== è½¬æ¢ä¸ºæ™®é€šAIæ¶ˆæ¯ =====
                currentStreamingMessage.className = 'message ai-message';

                // ===== æ¸…é™¤ä¸´æ—¶å±æ€§ =====
                currentStreamingMessage.id = '';
                currentStreamingMessage.removeAttribute('data-content-id');

                // ===== ç§»é™¤æµå¼ä¿¡æ¯ =====
                const streamInfo = currentStreamingMessage.querySelector('.stream-info');
                if (streamInfo) {
                    streamInfo.remove();
                }

                // ===== é‡ç½®å¼•ç”¨ =====
                currentStreamingMessage = null;
            }

            // ===== é‡ç½®å…¨å±€çŠ¶æ€ =====
            isProcessing = false;
            setButtonDisabled(false);
            document.getElementById('messageInput').focus();  // é‡æ–°èšç„¦è¾“å…¥æ¡†
        }

        /**
         * è®¾ç½®æŒ‰é’®çŠ¶æ€
         * åŠŸèƒ½ï¼šæ§åˆ¶å‘é€æŒ‰é’®çš„å¯ç”¨æ€§å’Œæ˜¾ç¤ºæ–‡æœ¬
         *
         * @param {boolean} disabled - æ˜¯å¦ç¦ç”¨æŒ‰é’®
         */
        function setButtonDisabled(disabled) {
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = disabled;

            // ===== æ›´æ–°æŒ‰é’®æ–‡æœ¬ =====
            if (disabled) {
                sendBtn.textContent = 'å¤„ç†ä¸­...';
            } else {
                sendBtn.textContent = 'ğŸŒŠ å‘é€æ¶ˆæ¯';
            }
        }

        /**
         * æ»šåŠ¨åˆ°èŠå¤©æ¡†åº•éƒ¨
         * åŠŸèƒ½ï¼šç¡®ä¿æ–°æ¶ˆæ¯å§‹ç»ˆå¯è§
         */
        function scrollToBottom() {
            const chatBox = document.getElementById('chatBox');
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // ===== é¡µé¢åˆå§‹åŒ– =====
        /**
         * DOMåŠ è½½å®Œæˆäº‹ä»¶å¤„ç†
         * åŠŸèƒ½ï¼šé¡µé¢åŠ è½½åçš„åˆå§‹åŒ–æ“ä½œ
         */
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('messageInput').focus();  // è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
            console.log('ğŸ‰ é¡µé¢åŠ è½½å®Œæˆï¼Œæµå¼ä¼ è¾“èŠå¤©ç•Œé¢å·²å°±ç»ª');
        });
    </script>
</body>
</html>

<!--
===== æ•´ä½“æ¶æ„æ€»ç»“ =====

1. HTMLç»“æ„å±‚ï¼š
   - è¯­ä¹‰åŒ–æ ‡ç­¾ï¼šåˆç†ä½¿ç”¨divã€inputã€buttonç­‰
   - å“åº”å¼è®¾è®¡ï¼šviewporté…ç½®å’Œå¼¹æ€§å¸ƒå±€
   - å¯è®¿é—®æ€§ï¼šåˆç†çš„æ ‡ç­¾å±‚æ¬¡å’Œè¯­ä¹‰

2. CSSæ ·å¼å±‚ï¼š
   - æ¨¡å—åŒ–è®¾è®¡ï¼šåŠŸèƒ½åŒºåŸŸæ ·å¼åˆ†ç¦»
   - å“åº”å¼å¸ƒå±€ï¼šé€‚é…ä¸åŒå±å¹•å°ºå¯¸
   - åŠ¨ç”»æ•ˆæœï¼šæ‰“å­—æŒ‡ç¤ºå™¨å’ŒçŠ¶æ€æŒ‡ç¤ºå™¨
   - ç”¨æˆ·ä½“éªŒï¼šæ‚¬åœæ•ˆæœå’ŒçŠ¶æ€åé¦ˆ

3. JavaScripté€»è¾‘å±‚ï¼š
   - çŠ¶æ€ç®¡ç†ï¼šå…¨å±€çŠ¶æ€å˜é‡æ§åˆ¶æµç¨‹
   - äº‹ä»¶å¤„ç†ï¼šç”¨æˆ·äº¤äº’å’Œæµæ•°æ®å¤„ç†
   - DOMæ“ä½œï¼šåŠ¨æ€åˆ›å»ºå’Œæ›´æ–°æ¶ˆæ¯å…ƒç´ 
   - é”™è¯¯å¤„ç†ï¼šç½‘ç»œé”™è¯¯å’Œæ•°æ®è§£æå®¹é”™

4. æµå¼ä¼ è¾“æ ¸å¿ƒï¼š
   - Fetch APIï¼šå‘èµ·HTTPè¯·æ±‚
   - ReadableStreamï¼šå¤„ç†å“åº”æ•°æ®æµ
   - SSEåè®®ï¼šè§£ææœåŠ¡å™¨å‘é€çš„äº‹ä»¶æ•°æ®
   - å®æ—¶æ›´æ–°ï¼šé€æ­¥æ˜¾ç¤ºAIç”Ÿæˆå†…å®¹

===== å…³é”®æŠ€æœ¯ç‰¹ç‚¹ =====

1. ç”¨æˆ·ä½“éªŒä¼˜åŒ–ï¼š
   - å®æ—¶åé¦ˆï¼šæ‰“å­—æŒ‡ç¤ºå™¨å’ŒçŠ¶æ€å˜åŒ–
   - é˜²é‡å¤æäº¤ï¼šçŠ¶æ€æ§åˆ¶é¿å…å¹¶å‘é—®é¢˜
   - è‡ªåŠ¨æ»šåŠ¨ï¼šæ–°æ¶ˆæ¯å§‹ç»ˆå¯è§
   - é”®ç›˜æ”¯æŒï¼šå›è½¦å¿«æ·å‘é€

2. æ•°æ®å¤„ç†å¥å£®æ€§ï¼š
   - æµå¼è§£æï¼šæ”¯æŒä¸å®Œæ•´æ•°æ®å—
   - é”™è¯¯å®¹é”™ï¼šJSONè§£æå¼‚å¸¸å¤„ç†
   - çŠ¶æ€åŒæ­¥ï¼šå‰åç«¯çŠ¶æ€ä¸€è‡´æ€§
   - å†…å­˜ç®¡ç†ï¼šåŠæ—¶æ¸…ç†DOMå¼•ç”¨

3. å¯æ‰©å±•æ€§è®¾è®¡ï¼š
   - æ¨¡å—åŒ–å‡½æ•°ï¼šåŠŸèƒ½å•ä¸€èŒè´£æ˜ç¡®
   - é…ç½®åŒ–æ ·å¼ï¼šCSSå˜é‡æ˜“äºå®šåˆ¶
   - äº‹ä»¶é©±åŠ¨ï¼šæ¾è€¦åˆçš„äº¤äº’è®¾è®¡
   - æ ‡å‡†åè®®ï¼šéµå¾ªSSEå’ŒHTTPè§„èŒƒ
-->